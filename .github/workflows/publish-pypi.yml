name: Publish to PyPI (release tags)

on:
  push:
    tags:
      - "v*"

permissions:
  contents: read

jobs:
  validate:
    name: Validate release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.8"

      - name: Extract tag version
        id: tag
        run: |
          TAG_VERSION="${GITHUB_REF#refs/tags/v}"
          echo "version=${TAG_VERSION}" >> "$GITHUB_OUTPUT"

      - name: Validate release commit message
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%s)
          echo "Commit message: $COMMIT_MSG"

          if ! echo "$COMMIT_MSG" | grep -Eq '^chore\(release\): [0-9]+\.[0-9]+\.[0-9]+$'; then
            echo "Invalid release commit message"
            exit 1
          fi

          MSG_VERSION=$(echo "$COMMIT_MSG" | sed -E 's/^chore\(release\): ([0-9]+\.[0-9]+\.[0-9]+)$/\1/')
          if [ "$MSG_VERSION" != "${{ steps.tag.outputs.version }}" ]; then
            echo "Commit version does not match tag"
            exit 1
          fi

      - name: Validate pyproject.toml version matches tag
        run: |
          FILE_VERSION=$(grep -E '^version\s*=\s*"[0-9]+\.[0-9]+\.[0-9]+"' pyproject.toml \
            | sed -E 's/.*"([0-9]+\.[0-9]+\.[0-9]+)"/\1/')

          if [ "$FILE_VERSION" != "${{ steps.tag.outputs.version }}" ]; then
            echo "pyproject.toml version does not match tag"
            exit 1
          fi

      - name: Validate CHANGELOG entry exists
        run: |
          if ! grep -q "\[${{ steps.tag.outputs.version }}\]" CHANGELOG.md; then
            echo "CHANGELOG missing version section"
            exit 1
          fi

      - name: Ensure tag commit is on main
        run: |
          git fetch origin main
          git merge-base --is-ancestor HEAD origin/main || {
            echo "Tagged commit is not on main"
            exit 1
          }

  publish:
    name: Build and publish to PyPI
    runs-on: ubuntu-latest
    needs: validate

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.8"

      - name: Install build tools
        run: |
          python -m pip install --upgrade pip
          pip install build twine

      - name: Build package
        run: python -m build

      - name: Upload to PyPI
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
        run: twine upload dist/*
